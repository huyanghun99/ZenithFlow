<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>个人导航</title>

    <!-- Tailwind CSS v3 (稳定版) -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Tailwind theme config -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: {
                            500: '#22C55E',
                            400: '#A3E635',
                            300: '#86EFAC',
                        },
                        dark: {
                            bg: '#111827',
                            surface: '#374151',
                            text: '#D1D5DB'
                        },
                        neutral: {
                            900: '#111827',
                            800: '#374151',
                        },
                        gray: {
                            300: '#D1D5DB'
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                        mono: ['ui-monospace', 'SFMono-Regular', 'Menlo', 'Monaco', 'Consolas', 'Liberation Mono', 'Courier New', 'monospace']
                    }
                }
            }
        }
    </script>

    <style>
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #374151; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #4B5563; }

        /* --- 配色方案 (霓虹绿+极客黑) --- */
        :root {
            --primary: #22C55E;       /* 主色：鲜亮绿 */
            --secondary: #A3E635;     /* 次色：酸橙绿 */
            --highlight: #86EFAC;     /* 强色：淡绿 */
            
            --bg-dark: #111827;       /* 页面背景 */
            --bg-card: #374151;       /* 卡片基础色 */
            --text-main: #f9fafb;     /* 主字色 */
            --text-sub: #9ca3af;      /* 副字色 */
            
            /* --- 组件变量 --- */
            --glass-bg: rgba(31, 41, 55, 0.6);        /* 卡片玻璃底色 */
            --glass-border: rgba(255, 255, 255, 0.08);/* 边框 */
            --card-hover: rgba(55, 65, 81, 0.95);     /* 悬停高亮 */
            --danger: #ef4444;
            
            --bg-gradient: linear-gradient(180deg, #111827 0%, #020617 100%);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            /* 保持清爽的系统默认字体 */
            font-family: -apple-system, "Microsoft YaHei", "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            -webkit-font-smoothing: antialiased;
        }

        body {
            min-height: 100vh;
            background-image: var(--bg-gradient);
            background-color: var(--bg-dark);
            background-attachment: fixed;
            padding: 0;
            color: var(--text-main);
            overflow-y: scroll;
            display: flex;
            flex-direction: column;
        }

        /* 头部与搜索 */
        .clock {
            font-size: 4rem;
            font-weight: 700;
            color: var(--primary);
            text-shadow: 0 0 25px rgba(34, 197, 94, 0.25);
            margin-bottom: 5px;
            letter-spacing: -1px;
        }
        
        .date-display {
            color: var(--text-sub);
            font-size: 0.95rem;
            margin-bottom: 30px;
            font-weight: 400;
            opacity: 0.8;
        }

        /* 搜索 */
        .search-wrapper {
            width: 100%;
            max-width: 600px;
            margin: 0 auto 40px auto;
            position: relative;
            z-index: 10;
        }

        .search-input {
            width: 100%;
            padding: 14px 20px 14px 50px;
            border-radius: 12px; 
            border: 1px solid var(--glass-border);
            background: rgba(31, 41, 55, 0.8);
            backdrop-filter: blur(12px);
            font-size: 1.1rem;
            outline: none;
            transition: all 0.3s;
            color: var(--text-main);
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }

        .search-input:focus {
            background: rgba(17, 24, 39, 0.95);
            border-color: var(--primary);
            box-shadow: 0 0 20px rgba(34, 197, 94, 0.15);
        }
        
        .search-icon {
            position: absolute; left: 20px; top: 50%; transform: translateY(-50%);
            color: var(--text-sub); width: 20px;
        }

        /* --- 分组容器 --- */
        .main-container { width: 100%; max-width: 1200px; margin: 0 auto; }

        .group-section {
            margin-bottom: 30px;
            transition: transform 0.2s;
            border-radius: 16px;
        }
        .group-section.dragging-over {
            background: rgba(34, 197, 94, 0.05);
            border: 2px dashed var(--primary);
        }

        .group-header {
            display: flex; align-items: center; margin-bottom: 15px; padding-left: 5px;
            cursor: default;
        }
        .edit-mode .group-header { cursor: grab; }

        .group-title {
            font-size: 1.05rem; font-weight: 600; color: var(--highlight);
            background: rgba(34, 197, 94, 0.1);
            padding: 6px 14px;
            border-radius: 8px;
            border: 1px solid rgba(34, 197, 94, 0.2);
        }

        .group-actions { margin-left: 10px; display: none; gap: 8px; }
        .edit-mode .group-actions { display: flex; }
        
        .btn-mini {
            border: none; width: 24px; height: 24px; border-radius: 4px; cursor: pointer;
            display: flex; align-items: center; justify-content: center; color: #000; transition: 0.2s;
        }
        .btn-edit-group { background: var(--secondary); }
        .btn-del-group { background: var(--danger); color: #fff;}

        /* --- 网格布局 --- */
        .grid-wrapper {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 16px; min-height: 100px; padding: 4px;
        }

        /* --- 卡片样式 --- */
        .card {
            aspect-ratio: 1/1;
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            border-radius: 18px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            text-decoration: none; cursor: pointer; transition: all 0.2s;
            position: relative; padding: 10px; user-select: none;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }

        .card:hover {
            background: var(--card-hover); transform: translateY(-4px);
            border-color: var(--primary);
            box-shadow: 0 10px 20px rgba(0,0,0,0.5), 0 0 15px rgba(34, 197, 94, 0.15);
        }

        /* --- 纯CSS首字图标样式 (核心修改) --- */
        .text-icon {
            width: 48px; 
            height: 48px;
            background: rgba(17, 24, 39, 0.5); /* 深色半透明底 */
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.6rem;
            font-weight: 700;
            color: var(--primary); /* 霓虹绿字体 */
            margin-bottom: 10px;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.3); /* 内阴影增加凹陷感 */
            pointer-events: none; /* 防止点击文字触发其他事件 */
            text-shadow: 0 0 10px rgba(34, 197, 94, 0.4); /* 文字发光 */
            font-family: Arial, Helvetica, sans-serif; /* 确保英文字母居中对齐 */
        }
        
        .card:hover .text-icon {
            color: var(--secondary);
            border-color: var(--primary);
            box-shadow: 0 0 10px rgba(34, 197, 94, 0.2);
        }

        .card span {
            font-size: 0.85rem; color: var(--text-sub); font-weight: 500;
            width: 100%; text-align: center; white-space: nowrap;
            overflow: hidden; text-overflow: ellipsis; pointer-events: none;
            transition: color 0.2s;
        }
        .card:hover span { color: var(--primary); }

        /* 拖拽与编辑 */
        .edit-mode .card { cursor: grab; }
        .edit-mode .card:active { cursor: grabbing; }
        .card.dragging { opacity: 0.4; transform: scale(0.9); border: 1px dashed var(--primary); }
        
        .card-del-btn {
            position: absolute; top: -8px; left: -8px; width: 22px; height: 22px;
            background: var(--danger); border-radius: 50%; color: white;
            display: none; align-items: center; justify-content: center;
            font-size: 14px; z-index: 5; border: 2px solid var(--bg-dark);
        }
        .edit-mode .card-del-btn { display: flex; cursor: pointer; }
        .card-edit-overlay { position: absolute; inset: 0; z-index: 4; display: none; }
        .edit-mode .card-edit-overlay { display: block; }

        /* 添加按钮 */
        .add-card {
            border: 1px dashed rgba(255,255,255,0.15); background: transparent; box-shadow: none;
        }
        .add-card:hover { border-color: var(--primary); background: rgba(34,197,94,0.05); }
        .add-card svg { color: var(--text-sub); width: 24px; height: 24px; transition: color 0.2s;}
        .add-card:hover svg { color: var(--primary); }
        .edit-mode .add-card { display: flex; }

        /* --- 控制栏 --- */
        .control-bar {
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
            background: rgba(17, 24, 39, 0.9); backdrop-filter: blur(16px);
            padding: 8px 24px; border-radius: 50px; display: flex; gap: 16px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.6); border: 1px solid var(--glass-border);
            z-index: 100; align-items: center;
        }

        .ctrl-btn {
            background: none; border: none; padding: 8px 12px; border-radius: 20px;
            cursor: pointer; font-weight: 600; font-size: 0.9rem; color: var(--text-sub);
            display: flex; align-items: center; gap: 6px; transition: 0.2s; white-space: nowrap;
        }
        .ctrl-btn:hover { color: var(--primary); }
        .ctrl-btn.primary {
            background: var(--primary); color: #000; padding: 8px 20px;
        }
        .ctrl-btn.primary:hover { background: var(--secondary); transform: translateY(-1px); }

        /* --- 弹窗 --- */
        .modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.8);
            backdrop-filter: blur(5px); display: none; justify-content: center; align-items: center; z-index: 1000;
        }
        .modal {
            background: #1f2937; width: 90%; max-width: 380px; border-radius: 20px; padding: 30px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.7); border: 1px solid #374151;
            animation: popIn 0.2s ease-out;
        }
        .modal h3 { color: var(--primary); margin-bottom: 20px; font-size: 1.2rem; }
        .form-group { margin-bottom: 18px; }
        .form-group label { display: block; margin-bottom: 8px; color: var(--text-sub); font-size: 0.9rem; }
        .form-group input {
            width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #4b5563;
            background: #111827; color: var(--highlight); outline: none; transition: 0.2s;
        }
        .form-group input:focus { border-color: var(--primary); }
        
        .modal-btns { display: flex; justify-content: flex-end; gap: 12px; margin-top: 24px; }
        .btn { padding: 10px 20px; border-radius: 8px; border: none; font-weight: 600; cursor: pointer; }
        .btn-confirm { background: var(--primary); color: #000; }
        .btn-cancel { background: #374151; color: var(--text-sub); border: 1px solid #4b5563; }
        .btn-cancel:hover { color: white; border-color: #6b7280; }

        @keyframes popIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }

    </style>
</head>
<body class="bg-[linear-gradient(180deg,#111827_0%,#020617_100%)] text-gray-300 h-screen overflow-hidden selection:bg-brand-500 selection:text-white font-sans">

    <!-- Global Top Navigation -->
    <header class="h-14 bg-[#111827]/80 backdrop-blur border-b border-neutral-800 flex items-center justify-between px-4 shrink-0 z-50">
        <div class="flex items-center gap-6">
            <div class="flex items-center gap-2">
                <span class="w-4 h-4 rounded-md bg-brand-500 shadow-[0_0_10px_rgba(34,197,94,0.5)]"></span>
                <h1 class="text-lg font-bold text-white tracking-tight">ZenithFlow</h1>
            </div>
            
            <nav class="hidden md:flex items-center space-x-1">
                <button class="px-3 py-1.5 text-sm text-gray-400 hover:text-white hover:bg-neutral-800/30 rounded-md transition-colors" onclick="window.location.href='/'">工作台</button>
                <a href="/nav" class="px-3 py-1.5 text-sm text-white bg-neutral-800/50 rounded-md border border-neutral-700 font-medium">导航</a>
            </nav>
        </div>

        <div class="flex items-center gap-3">
            <div class="w-8 h-8 rounded-full bg-gradient-to-tr from-brand-500 to-brand-400 flex items-center justify-center text-neutral-900 font-bold text-xs shadow-lg">
                U
            </div>
        </div>
    </header>

    <div class="flex flex-col flex-1 min-h-0 overflow-hidden">
        <main class="flex-1 overflow-y-auto p-4">
            <div class="text-center mt-6">
                <div class="clock" id="clock">00:00</div>
                <div class="date-display" id="dateDisplay">Loading...</div>
            </div>

            <!-- 搜索 -->
            <div class="search-wrapper">
                <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
                <input type="text" class="search-input" id="searchInput" placeholder="搜索 Bing..." autocomplete="off">
            </div>

            <div class="main-container" id="container"></div>
        </main>
    </div>

    <!-- 底部 -->
    <div class="control-bar">
            <button class="ctrl-btn" onclick="exportData()">
                <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                备份
            </button>
            <button class="ctrl-btn" onclick="triggerImport()">
                <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                恢复
            </button>
            <div style="width: 1px; height: 16px; background: #4b5563;"></div>
            <button class="ctrl-btn" onclick="openGroupModal()">+ 分组</button>
            <button class="ctrl-btn primary" id="editToggle" onclick="toggleEdit()">整理桌面</button>
        </div>
    <input type="file" id="fileInput" style="display:none" accept=".json" onchange="importData(this)">

    <!-- 弹窗 -->
    <div class="modal-overlay" id="siteModal">
        <div class="modal">
            <h3 id="siteModalTitle">添加网站</h3>
            <div class="form-group">
                <label>名称</label>
                <input type="text" id="siteNameInput" placeholder="网站名称">
            </div>
            <div class="form-group">
                <label>网址</label>
                <input type="text" id="siteUrlInput" placeholder="https://example.com">
            </div>
            <div class="modal-btns">
                <button class="btn btn-cancel" onclick="closeSiteModal()">取消</button>
                <button class="btn btn-confirm" onclick="saveSite()">确认</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="groupModal">
        <div class="modal">
            <h3 id="groupModalTitle">新建分组</h3>
            <div class="form-group">
                <label>分组名称</label>
                <input type="text" id="groupNameInput" placeholder="分组名称">
            </div>
            <div class="modal-btns">
                <button class="btn btn-cancel" onclick="closeGroupModal()">取消</button>
                <button class="btn btn-confirm" onclick="saveGroup()">确认</button>
            </div>
        </div>
    </div>

    <script>
        const DEFAULT_DATA = [
            {
                id: 'g1', title: '常用',
                links: [
                    { id: 1, name: 'Bing', url: 'https://cn.bing.com' },
                    { id: 2, name: 'Bilibili', url: 'https://www.bilibili.com' },
                    { id: 3, name: 'Zhihu', url: 'https://www.zhihu.com' }
                ]
            },
            {
                id: 'g2', title: '开发',
                links: [
                    { id: 4, name: 'GitHub', url: 'https://github.com' },
                    { id: 5, name: 'V2EX', url: 'https://www.v2ex.com' },
                    { id: 6, name: 'DeepSeek', url: 'https://chat.deepseek.com' }
                ]
            }
        ];

        let groups = [];
        let isEditMode = false;
        let editingGroupId = null;
        let editingLinkId = null;
        let draggedItem = null; 

        window.onload = function() {
            loadData();
            updateTime();
            setInterval(updateTime, 1000);

            document.getElementById('searchInput').addEventListener('keypress', function(e){
                if(e.key === 'Enter' && this.value.trim()){
                    window.open(`https://cn.bing.com/search?q=${encodeURIComponent(this.value)}`, '_blank');
                }
            });
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') { closeSiteModal(); closeGroupModal(); }
            });
        };

        function updateTime() {
            const now = new Date();
            document.getElementById('clock').innerText = now.toLocaleTimeString('zh-CN', {hour:'2-digit', minute:'2-digit'});
            document.getElementById('dateDisplay').innerText = now.toLocaleDateString('zh-CN', {year:'numeric', month:'long', day:'numeric', weekday:'long'});
        }

        function loadData() {
            // 从后端API获取数据
            fetch('/api/nav')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        groups = data.data;
                        render();
                    }
                })
                .catch(err => {
                    console.error('加载数据失败:', err);
                    // 加载失败时使用默认数据
                    groups = DEFAULT_DATA;
                    render();
                });
        }
        function saveData() {
            // 保存数据到后端API
            fetch('/api/nav', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(groups)
            })
            .then(response => response.json())
            .catch(err => {
                console.error('保存数据失败:', err);
            });
        }

        function render() {
            const container = document.getElementById('container');
            container.innerHTML = '';

            groups.forEach((group, gIndex) => {
                const section = document.createElement('div');
                section.className = 'group-section';
                section.dataset.gid = group.id;
                
                const header = document.createElement('div');
                header.className = 'group-header';
                if(isEditMode) {
                    header.draggable = true;
                    header.ondragstart = (e) => handleGroupDragStart(e, gIndex);
                    header.ondragover = (e) => handleGroupDragOver(e); 
                    header.ondrop = (e) => handleGroupDrop(e, gIndex);
                }

                header.innerHTML = `
                    <div class="group-title">${group.title}</div>
                    <div class="group-actions">
                        <button class="btn-mini btn-edit-group" onclick="openGroupModal('${group.id}')">✎</button>
                        <button class="btn-mini btn-del-group" onclick="deleteGroup('${group.id}')">×</button>
                    </div>
                `;
                section.appendChild(header);

                const grid = document.createElement('div');
                grid.className = 'grid-wrapper';
                if(isEditMode) {
                    grid.ondragover = (e) => handleCardDragOver(e);
                    grid.ondrop = (e) => handleCardDropOnGrid(e, group.id);
                }

                group.links.forEach((link, lIndex) => {
                    const card = document.createElement('div');
                    card.className = 'card';
                    if(isEditMode) {
                        card.draggable = true;
                        card.ondragstart = (e) => handleCardDragStart(e, group.id, link.id, lIndex);
                        card.ondragover = (e) => handleCardDragOver(e);
                        card.ondrop = (e) => handleCardDrop(e, group.id, lIndex);
                    }

                    // --- 核心修改：直接提取首字显示 ---
                    const firstChar = link.name ? link.name.charAt(0).toUpperCase() : '?';

                    card.innerHTML = `
                        <div class="card-del-btn" onclick="deleteLink('${group.id}', ${link.id}, event)">×</div>
                        <div class="card-edit-overlay" onclick="openSiteModal('${group.id}', ${link.id})"></div>
                        <div class="text-icon">${firstChar}</div>
                        <span>${link.name}</span>
                    `;
                    
                    if(!isEditMode) card.onclick = () => window.open(link.url, '_blank');
                    grid.appendChild(card);
                });

                const addBtn = document.createElement('div');
                addBtn.className = 'card add-card';
                addBtn.innerHTML = `<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>`;
                addBtn.onclick = () => openSiteModal(group.id, null);
                grid.appendChild(addBtn);

                section.appendChild(grid);
                container.appendChild(section);
            });
            document.body.classList.toggle('edit-mode', isEditMode);
        }

        // --- 拖拽与交互逻辑 ---
        function handleCardDragStart(e, gid, lid, idx) {
            e.stopPropagation(); draggedItem = { type: 'card', groupId: gid, linkId: lid, index: idx };
            e.target.classList.add('dragging'); e.dataTransfer.effectAllowed = 'move';
        }
        function handleCardDragOver(e) { e.preventDefault(); e.dataTransfer.dropEffect = 'move'; }
        function handleCardDrop(e, tGid, tIdx) {
            e.preventDefault(); e.stopPropagation();
            if (!draggedItem || draggedItem.type !== 'card') return;
            moveCard(draggedItem.groupId, draggedItem.index, tGid, tIdx);
        }
        function handleCardDropOnGrid(e, tGid) {
            e.preventDefault();
            if (!draggedItem || draggedItem.type !== 'card') return;
            const tGroup = groups.find(g => g.id === tGid);
            if(tGroup) moveCard(draggedItem.groupId, draggedItem.index, tGid, tGroup.links.length);
        }
        function moveCard(sGid, sIdx, tGid, tIdx) {
            const sGroup = groups.find(g => g.id === sGid);
            const tGroup = groups.find(g => g.id === tGid);
            if(!sGroup || !tGroup) return;
            const [movedItem] = sGroup.links.splice(sIdx, 1);
            tGroup.links.splice(tIdx, 0, movedItem);
            saveData(); render(); draggedItem = null;
        }
        function handleGroupDragStart(e, idx) {
            draggedItem = { type: 'group', index: idx };
            e.target.closest('.group-section').classList.add('dragging');
        }
        function handleGroupDragOver(e) { e.preventDefault(); }
        function handleGroupDrop(e, tIdx) {
            e.preventDefault();
            if (!draggedItem || draggedItem.type !== 'group') return;
            if (draggedItem.index === tIdx) return;
            const [movedGroup] = groups.splice(draggedItem.index, 1);
            groups.splice(tIdx, 0, movedGroup);
            saveData(); render(); draggedItem = null;
        }

        function toggleEdit() {
            isEditMode = !isEditMode;
            const btn = document.getElementById('editToggle');
            btn.innerText = isEditMode ? '完成' : '整理桌面';
            btn.style.background = isEditMode ? 'var(--secondary)' : 'var(--primary)';
            render();
        }

        function openSiteModal(gid, lid) {
            editingGroupId = gid; editingLinkId = lid;
            const modal = document.getElementById('siteModal');
            const title = document.getElementById('siteModalTitle');
            const nameInput = document.getElementById('siteNameInput');
            const urlInput = document.getElementById('siteUrlInput');
            modal.style.display = 'flex';
            if (lid) {
                const group = groups.find(g => g.id == gid);
                const link = group.links.find(l => l.id == lid);
                title.innerText = '编辑网站'; nameInput.value = link.name; urlInput.value = link.url;
            } else {
                title.innerText = '添加网站'; nameInput.value = ''; urlInput.value = '';
            }
            nameInput.focus();
        }
        function closeSiteModal() { document.getElementById('siteModal').style.display = 'none'; }
        function saveSite() {
            const name = document.getElementById('siteNameInput').value.trim();
            let url = document.getElementById('siteUrlInput').value.trim();
            if (!name || !url) return alert('请输入完整信息');
            if (!/^https?:\/\//i.test(url)) url = 'https://' + url;
            const gIdx = groups.findIndex(g => g.id == editingGroupId);
            if (editingLinkId) {
                const lIdx = groups[gIdx].links.findIndex(l => l.id == editingLinkId);
                groups[gIdx].links[lIdx] = { ...groups[gIdx].links[lIdx], name, url };
            } else {
                groups[gIdx].links.push({ id: Date.now(), name, url });
            }
            saveData(); render(); closeSiteModal();
        }
        function deleteLink(gid, lid, e) {
            e.stopPropagation();
            if(confirm('确定删除？')) {
                const g = groups.find(g => g.id == gid);
                g.links = g.links.filter(l => l.id != lid);
                saveData(); render();
            }
        }
        function openGroupModal(gid = null) {
            editingGroupId = gid;
            const modal = document.getElementById('groupModal');
            const input = document.getElementById('groupNameInput');
            document.getElementById('groupModalTitle').innerText = gid ? '重命名分组' : '新建分组';
            modal.style.display = 'flex';
            input.value = gid ? groups.find(g => g.id == gid).title : '';
            input.focus();
        }
        function closeGroupModal() { document.getElementById('groupModal').style.display = 'none'; }
        function saveGroup() {
            const title = document.getElementById('groupNameInput').value.trim();
            if(!title) return;
            if(editingGroupId) { groups.find(g => g.id == editingGroupId).title = title; }
            else { groups.push({ id: 'g-'+Date.now(), title, links:[] }); }
            saveData(); render(); closeGroupModal();
        }
        function deleteGroup(gid) {
            if(confirm('删除分组及所有内容？')) {
                groups = groups.filter(g => g.id != gid);
                saveData(); render();
            }
        }
        function exportData() {
            const blob = new Blob([JSON.stringify(groups,null,2)], {type:"application/json"});
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
            a.download = `nav_backup_${new Date().toISOString().slice(0,10)}.json`; a.click();
        }
        function triggerImport() { document.getElementById('fileInput').click(); }
        function importData(input) {
            const r = new FileReader();
            r.onload = (e) => {
                try { groups = JSON.parse(e.target.result); saveData(); render(); alert('恢复成功'); }
                catch(e) { alert('文件格式错误'); }
            };
            if(input.files[0]) r.readAsText(input.files[0]);
        }
    </script>
</body>
</html>